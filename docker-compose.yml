services:
  # TimescaleDB - Time-series database for OSRS market data
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: osrs-timescaledb
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-osrs_trader}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me_in_env_file}
      POSTGRES_DB: ${POSTGRES_DB:-osrs_market}
      TZ: UTC
      PGTZ: UTC
    volumes:
      - timescale_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./database/migrations:/docker-entrypoint-initdb.d/migrations:ro
    ports:
      - "${DB_PORT:-5432}:5432"
    networks:
      - osrs-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-osrs_trader} -d ${POSTGRES_DB:-osrs_market}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    command: >
      postgres
      -c timezone=UTC
      -c log_timezone=UTC

  # Real-time data collector
  realtime-collector:
    build:
      context: .
      dockerfile: Dockerfile.collector
    container_name: osrs-realtime-collector
    restart: unless-stopped
    depends_on:
      timescaledb:
        condition: service_healthy
    environment:
      - COLLECTOR_TYPE=realtime
      - POSTGRES_HOST=timescaledb
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-osrs_trader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-change_me_in_env_file}
      - POSTGRES_DB=${POSTGRES_DB:-osrs_market}
      - API_BASE_URL=${API_BASE_URL:-https://prices.runescape.wiki/api/v1/osrs}
      - API_USER_AGENT=${API_USER_AGENT:-OSRS-Market-Collector/1.0}
      - API_RATE_LIMIT_SECONDS=${API_RATE_LIMIT_SECONDS:-1.0}
      - FAST_CATCHUP_THRESHOLD_MINUTES=${FAST_CATCHUP_THRESHOLD_MINUTES:-15}
      - FAST_CATCHUP_INTERVAL_MINUTES=${FAST_CATCHUP_INTERVAL_MINUTES:-2.5}
      - RESTART_OVERLAP_MINUTES=${RESTART_OVERLAP_MINUTES:-5}
      - STATE_SYNC_FREQUENCY=${STATE_SYNC_FREQUENCY:-100}
      - TIMEZONE_STRICT_MODE=${TIMEZONE_STRICT_MODE:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TEST_MODE=${TEST_MODE:-false}
      - TEST_ITEM_IDS=${TEST_ITEM_IDS:-}
    volumes:
      - ./logs:/app/logs
      - ./collectors:/app/collectors:ro
    networks:
      - osrs-network
    # Healthcheck: Check if process is running and recently logged activity
    healthcheck:
      test: ["CMD", "sh", "-c", "ps aux | grep -q '[p]ython.*realtime' && [ -f /app/logs/realtime_collector.log ] && find /app/logs/realtime_collector.log -mmin -2 | grep -q ."]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Historical backfill collector
  backfill-collector:
    build:
      context: .
      dockerfile: Dockerfile.collector
    container_name: osrs-backfill-collector
    restart: on-failure:3
    depends_on:
      timescaledb:
        condition: service_healthy
      realtime-collector:
        condition: service_started
    environment:
      - COLLECTOR_TYPE=backfill
      - POSTGRES_HOST=timescaledb
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-osrs_trader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-change_me_in_env_file}
      - POSTGRES_DB=${POSTGRES_DB:-osrs_market}
      - API_BASE_URL=${API_BASE_URL:-https://prices.runescape.wiki/api/v1/osrs}
      - API_USER_AGENT=${API_USER_AGENT:-OSRS-Market-Collector/1.0}
      - API_RATE_LIMIT_SECONDS=${API_RATE_LIMIT_SECONDS:-1.0}
      - HISTORICAL_BACKFILL_MONTHS=${HISTORICAL_BACKFILL_MONTHS:-6}
      - RESTART_OVERLAP_MINUTES=${RESTART_OVERLAP_MINUTES:-5}
      - STATE_SYNC_FREQUENCY=${STATE_SYNC_FREQUENCY:-100}
      - TIMEZONE_STRICT_MODE=${TIMEZONE_STRICT_MODE:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TEST_MODE=${TEST_MODE:-false}
      - TEST_ITEM_IDS=${TEST_ITEM_IDS:-}
    volumes:
      - ./logs:/app/logs
      - ./collectors:/app/collectors:ro
    networks:
      - osrs-network

  # Metadata collector (runs periodically)
  metadata-collector:
    build:
      context: .
      dockerfile: Dockerfile.collector
    container_name: osrs-metadata-collector
    restart: unless-stopped
    depends_on:
      timescaledb:
        condition: service_healthy
    environment:
      - COLLECTOR_TYPE=metadata
      - POSTGRES_HOST=timescaledb
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-osrs_trader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-change_me_in_env_file}
      - POSTGRES_DB=${POSTGRES_DB:-osrs_market}
      - API_BASE_URL=${API_BASE_URL:-https://prices.runescape.wiki/api/v1/osrs}
      - API_USER_AGENT=${API_USER_AGENT:-OSRS-Market-Collector/1.0}
      - API_RATE_LIMIT_SECONDS=${API_RATE_LIMIT_SECONDS:-1.0}
      - METADATA_UPDATE_INTERVAL_HOURS=${METADATA_UPDATE_INTERVAL_HOURS:-24}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TIMEZONE_STRICT_MODE=${TIMEZONE_STRICT_MODE:-true}
    volumes:
      - ./logs:/app/logs
      - ./collectors:/app/collectors:ro
    networks:
      - osrs-network
    # Run once on startup, then the script handles periodic updates

  # Grafana - Monitoring and visualization
  grafana:
    image: grafana/grafana:latest
    container_name: osrs-grafana
    restart: unless-stopped
    depends_on:
      timescaledb:
        condition: service_healthy
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
      - TZ=UTC
      # Database credentials for datasource provisioning
      - POSTGRES_USER=${POSTGRES_USER:-osrs_trader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-change_me_in_env_file}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    networks:
      - osrs-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  timescale_data:
    driver: local
  grafana_data:
    driver: local

networks:
  osrs-network:
    driver: bridge
