{
  "dashboard": {
    "title": "OSRS Price Data - Gap Detection",
    "tags": ["osrs", "monitoring", "gaps"],
    "timezone": "utc",
    "schemaVersion": 36,
    "refresh": "5s",
    "panels": [
      {
        "id": 1,
        "title": "Timestamp Gaps (Missing 5-min Intervals)",
        "type": "table",
        "targets": [
          {
            "format": "table",
            "rawSql": "WITH expected_intervals AS (\n    SELECT generate_series(\n        $__timeFrom(),\n        $__timeTo(),\n        INTERVAL '5 minutes'\n    ) as expected_time\n),\nactual_intervals AS (\n    SELECT DISTINCT timestamp as actual_time\n    FROM prices\n    WHERE timestamp BETWEEN $__timeFrom() AND $__timeTo()\n)\nSELECT\n    expected_time as \"Missing Timestamp\",\n    'GAP' as \"Status\",\n    EXTRACT(EPOCH FROM (expected_time - LAG(expected_time) OVER (ORDER BY expected_time))) / 60 as \"Minutes Since Previous\"\nFROM expected_intervals\nLEFT JOIN actual_intervals ON expected_time = actual_time\nWHERE actual_time IS NULL\nORDER BY expected_time DESC\nLIMIT 100",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "align": "auto",
              "displayMode": "auto"
            }
          },
          "overrides": [
            {
              "matcher": {
                "id": "byName",
                "options": "Status"
              },
              "properties": [
                {
                  "id": "custom.displayMode",
                  "value": "color-background"
                },
                {
                  "id": "thresholds",
                  "value": {
                    "steps": [
                      {
                        "color": "red",
                        "value": null
                      }
                    ]
                  }
                }
              ]
            }
          ]
        },
        "gridPos": {
          "h": 10,
          "w": 12,
          "x": 0,
          "y": 0
        }
      },
      {
        "id": 2,
        "title": "Data Presence Timeline (Gaps = Empty Spots)",
        "type": "heatmap",
        "targets": [
          {
            "format": "time_series",
            "rawSql": "SELECT\n    time_bucket('5 minutes', timestamp) as time,\n    COUNT(*) as \"Record Count\"\nFROM prices\nWHERE $__timeFilter(timestamp)\nGROUP BY time_bucket('5 minutes', timestamp)\nORDER BY time",
            "refId": "B"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "scaleDistribution": {
                "type": "linear"
              }
            }
          }
        },
        "gridPos": {
          "h": 10,
          "w": 12,
          "x": 12,
          "y": 0
        },
        "heatmap": {
          "xAxis": {
            "show": true
          },
          "yAxis": {
            "show": true
          }
        }
      },
      {
        "id": 3,
        "title": "Gap Alert (Red = Missing Data)",
        "type": "timeseries",
        "targets": [
          {
            "format": "time_series",
            "rawSql": "WITH expected AS (\n    SELECT generate_series(\n        $__timeFrom(),\n        $__timeTo(),\n        INTERVAL '5 minutes'\n    ) as ts\n),\nactual AS (\n    SELECT DISTINCT timestamp as ts, 1 as has_data\n    FROM prices\n    WHERE timestamp BETWEEN $__timeFrom() AND $__timeTo()\n)\nSELECT\n    expected.ts as time,\n    CASE WHEN actual.has_data IS NULL THEN 1 ELSE 0 END as \"Gap\"\nFROM expected\nLEFT JOIN actual ON expected.ts = actual.ts\nORDER BY expected.ts",
            "refId": "C"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "points",
              "pointSize": 6,
              "showPoints": "always"
            },
            "color": {
              "mode": "fixed",
              "fixedColor": "red"
            },
            "min": 0,
            "max": 1
          }
        },
        "gridPos": {
          "h": 8,
          "w": 24,
          "x": 0,
          "y": 10
        }
      }
    ]
  }
}
